---
title: "raw_valb_EDA"
output: html_document
date: "2025-06-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This document will be responsible for extracting the `long-beach-va.data` file containing the raw data et, comprising **200 patient records** with **76 attributes**, including the target variable. The data is stored in an unconventional format: although it's a plain text file with space-separated values, **each patient record spans 10 rows**, and there are no header names provided in the data set specifically. The end of each record is indicated by the final field labeled `"name"`.

## Importing Libraries

```{r libraries}
library(tidyverse)
library(ggplot2)
library(corrplot)
library(readr)
library(dplyr)

# set the column names per the heart-disease.names text file
full_cols <- c(
  "id",       # 1. patient ID
  "ccf",      # 2. ccf (social security #; now dummy)
  "age",      # 3. age in years
  "sex",      # 4. sex (1=male; 0=female)
  "painloc",  # 5. chest pain location (1=substernal; 0=otherwise)
  "painexer", # 6. provoked by exertion (1=yes; 0=no)
  "relrest",  # 7. relieved after rest (1=yes; 0=no)
  "pncaden",  # 8. sum of 5, 6, and 7
  "cp",       # 9. chest pain type (1–4)
  "trestbps", # 10. resting blood pressure (mm Hg)
  "htn",      # 11. history of hypertension (1=yes; 0=no)
  "chol",     # 12. serum cholesterol (mg/dL)
  "smoke",    # 13. is a smoker (1=yes; 0=no)
  "cigs",     # 14. cigarettes per day
  "years",    # 15. years as a smoker
  "fbs",      # 16. fasting blood sugar > 120 mg/dL (1=yes; 0=no)
  "dm",       # 17. diabetes history (1=yes; 0=no)
  "famhist",  # 18. family history of CAD (1=yes; 0=no)
  "restecg",  # 19. resting ECG results (0–2)
  "ekgmo",    # 20. month of exercise ECG reading
  "ekgday",   # 21. day of exercise ECG reading
  "ekgyr",    # 22. year of exercise ECG reading
  "dig",      # 23. digitalis used during ECG (1=yes; 0=no)
  "prop",     # 24. beta blocker used (1=yes; 0=no)
  "nitr",     # 25. nitrates used (1=yes; 0=no)
  "pro",      # 26. calcium channel blocker used (1=yes; 0=no)
  "diuretic", # 27. diuretic used during ECG (1=yes; 0=no)
  "proto",    # 28. exercise protocol (1=Bruce, 2=Kottus, … 12=arm ergometer)
  "thaldur",  # 29. duration of exercise test (minutes)
  "thaltime", # 30. time when ST depression was noted
  "met",      # 31. mets achieved
  "thalach",  # 32. maximum heart rate achieved
  "thalrest", # 33. resting heart rate
  "tpeakbps", # 34. peak exercise BP (first part)
  "tpeakbpd", # 35. peak exercise BP (second part)
  "dummy",    # 36. (unused)
  "trestbpd", # 37. resting blood pressure (duplicate)
  "exang",    # 38. exercise‐induced angina (1=yes; 0=no)
  "xhypo",    # 39. (1=yes; 0=no)
  "oldpeak",  # 40. ST depression relative to rest
  "slope",    # 41. slope of the peak exercise ST segment (1–3)
  "rldv5",    # 42. height at rest
  "rldv5e",   # 43. height at peak exercise
  "ca",       # 44. number of major vessels (0–3) seen on fluoroscopy
  "restckm",  # 45. irrelevant
  "exerckm",  # 46. irrelevant
  "restef",   # 47. rest radionuclide ejection fraction
  "restwm",   # 48. rest wall motion abnormality (0–3)
  "exeref",   # 49. exercise radionuclide ejection fraction
  "exerwm",   # 50. exercise wall motion (0–3)
  "thal",     # 51. thalassemia (3=normal; 6=fixed; 7=reversible)
  "thalsev",  # 52. not used
  "thalpul",  # 53. not used
  "earlobe",  # 54. not used
  "cmo",      # 55. month of cardiac cath
  "cday",     # 56. day of cardiac cath
  "cyr",      # 57. year of cardiac cath
  "num",      # 58. diagnosis (0–4)
  "lmt",      # 59. left main coronary artery
  "ladprox",  # 60. left anterior descending proximal
  "laddist",  # 61. left anterior descending distal
  "diag",     # 62. diagonal
  "cxmain",   # 63. circumflex main
  "ramus",    # 64. ramus
  "om1",      # 65. obtuse marginal 1
  "om2",      # 66. obtuse marginal 2
  "rcaprox",  # 67. right coronary artery proximal
  "rcadist",  # 68. right coronary artery distal
  "lvx1",     # 69. not used
  "lvx2",     # 70. not used
  "lvx3",     # 71. not used
  "lvx4",     # 72. not used
  "lvf",      # 73. not used
  "cathef",   # 74. not used
  "junk",     # 75. not used
  "name"      # 76. last name (dummy string)
)
```

## Importing Data

```{r data}
# using readLines, to read in each line of the long-beach-va.data file
# read_table, read_csv proved difficult to use to extract
# outline is to use the occurrence of 'name' to distinguish unique observations
# extract all the lines
raw_lines <- readLines("../Data/Raw/long-beach-va.data")
# merge all lines into one string
all_text <- paste(raw_lines, collapse = " ")
# split each observation on name
obs <- strsplit(all_text, " name ")[[1]]

record_list <- map(obs, ~ {
  toks <- strsplit(.x, "\\s+")[[1]] # split strings at whitespace
  toks <- toks[toks != ""]  #empty token removal
  stopifnot(length(toks) == 75)  
  data.frame(matrix(toks, nrow = 1), 
             stringsAsFactors = FALSE)
})
# bind the rows
va_df_raw <- bind_rows(record_list)
# assign column names but leave out name 
colnames(va_df_raw) <- full_cols[1:75]
```

## Preprocessing 

```{r}
# set unused features as described in heart-disease.names
unused_features <- c("id", "ccf", "junk", "cathef", "lvf", "lvx4", "lvx3",
                     "lvx2", "lvx1", "dummy", "restckm", "exerckm", "thalsev",
                     "thalpul", "earlobe")
# remove the unused features from the data frame
va_df <- va_df_raw %>%
  select(-all_of(unused_features))
# convert all to numeric, then specifically set categorical features.
va_df <- va_df %>%
  mutate(across(everything(), ~ as.numeric(.))
         )
# address missing values which are -9 and -9.0
va_df <- va_df %>%
  mutate(across(everything(), ~ na_if(., -9))) %>%
  mutate(across(everything(), ~ na_if(., -9.0)))

## categorical features and their levels and labels
#sex
va_df$sex <- factor(va_df$sex, 
                    levels = c(0, 1), 
                    labels = c("Female", "Male")
                    )
#painloc
#unique(va_df$painloc)
va_df$painloc <- factor(va_df$painloc,
                        levels = c(0, 1), 
                        labels = c("Otherwise", "Substernal")
                        )
#painexer
#unique(va_df$painexer)
va_df$painexer <- factor(va_df$painexer,
                        levels = c(0, 1), 
                        labels = c("Otherwise", "Provoked by Exertion")
                        )
#relrest
#unique(va_df$relrest)
va_df$relrest <- factor(va_df$relrest,
                        levels = c(0, 1), 
                        labels = c("Otherwise", "Relieved after rest")
                        )
#cp
#unique(va_df$cp)
va_df$cp <- factor(va_df$cp,
                        levels = c(1, 2, 3, 4), 
                        labels = c("Typical Angina", "Atypical Angina", 
                                   "Non-anginal Pain", "Asymptomatic"), 
                   ordered = TRUE)
#smoke
#unique(va_df$smoke)
va_df$smoke <- factor(va_df$smoke,
                        levels = c(0, 1), 
                        labels = c("No", "Yes")
                        )
#fbs
#unique(va_df$fbs)
va_df$fbs <- factor(va_df$fbs,
                        levels = c(0, 1), 
                        labels = c("No", "Yes")
                        )
#dm
#unique(va_df$dm)
va_df$dm <- factor(va_df$dm,
                        levels = c(0, 1), 
                        labels = c("No", "Yes")
                        )
#famhist
#unique(va_df$famhist)
va_df$famhist <- factor(va_df$famhist,
                        levels = c(0, 1), 
                        labels = c("No", "Yes")
                        )
#restecg
#unique(va_df$restecg)
va_df$restecg <- factor(va_df$restecg,
                        levels = c(0, 1, 2), 
                        labels = c("Normal", "Abnormal", "Hypertrophy"), 
                   ordered = TRUE)
#dig
#unique(va_df$dig)
va_df$dig <- factor(va_df$dig,
                        levels = c(0, 1), 
                        labels = c("No", "Yes")
                        )
#prop
#unique(va_df$prop)
# find the number of 22's a feature outside the range/
#sum(va_df$prop == 22, na.rm = TRUE)
# convert the 22 to NA
va_df <- va_df %>%
  mutate(prop = ifelse(prop == 22, NA, prop))
#create factor
va_df$prop <- factor(va_df$prop,
                        levels = c(0, 1), 
                        labels = c("No", "Yes")
                        )
#nitr
#unique(va_df$nitr)
va_df$nitr <- factor(va_df$nitr,
                     levels = c(0, 1),
                     labels = c("No", "Yes")
                     )
#pro
#unique(va_df$pro)
va_df$pro <- factor(va_df$pro,
                     levels = c(0, 1),
                     labels = c("No", "Yes")
                     )
#diuretic
#unique(va_df$diuretic)
va_df$diuretic <- factor(va_df$diuretic,
                     levels = c(0, 1),
                     labels = c("No", "Yes")
                     )
#proto
#unique(va_df$proto)
va_df$proto <- factor(va_df$proto,
                     levels = c(0, 1),
                     labels = c("No", "Yes")
                     )
#exang
#unique(va_df$exang)
va_df$exang <- factor(va_df$exang,
                     levels = c(0, 1),
                     labels = c("No", "Yes")
                     )
#xhypo
#unique(va_df$xhypo)
va_df$xhypo <- factor(va_df$xhypo,
                     levels = c(0, 1),
                     labels = c("No", "Yes")
                     )
#slope
#unique(va_df$slope)
# check count of 0 valuyes
#sum(va_df$slope == 0, na.rm = TRUE)
# replace 0 with NA
va_df <- va_df %>%
  mutate(slope = ifelse(slope == 0, NA, slope))
# factor
va_df$slope <- factor(va_df$slope,
                     levels = c(1, 2, 3),
                     labels = c("Upsloping", "Flat", "Downsloping"),
                     ordered = TRUE
                     )
#restwm
#unique(va_df$restwm)
# check count of 0 valuyes
# factor
va_df$restwm <- factor(va_df$restwm,
                     levels = c(0, 1, 2, 3),
                     labels = c("None", "Mild/Moderate", "Moderate/Severe", 
                                "Akinesis"),
                     ordered = TRUE
                     )
#thal
#unique(va_df$thal)
# examine 1, 2, 5 values which are not in the documentation
# check count of 1,2,5 values
#sum(va_df$thal == 1, na.rm = TRUE)
#sum(va_df$thal == 2, na.rm = TRUE)
#sum(va_df$thal == 5, na.rm = TRUE)
# replace 1, 2, 5 with na
va_df <- va_df %>%
  mutate(thal = ifelse(thal == 1, NA, thal)) %>%
  mutate(thal = ifelse(thal == 2, NA, thal)) %>%
  mutate(thal = ifelse(thal == 5, NA, thal))

```

## Missing Data Analysis

```{r missing values}
## initial missing value summary stats
# get counts of missing per columns
colSums(is.na(va_df))
# percentage of missing in columns
round(colMeans(is.na(va_df)) * 100, 2)
# get the columns with greater than 50% of missing values
features_gtr50_na <- names(which(colMeans(is.na(va_df)) > 0.5)) 
features_gtr50_na
```


















